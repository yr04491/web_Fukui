# Google Apps Script (GAS) セットアップガイド

## 概要

このガイドでは、体験談検索機能を実装するためのGoogle Apps Script (GAS)のセットアップ手順を説明します。

## 前提条件

- Googleアカウントを持っていること
- 体験談データを保存するGoogleスプレッドシートを作成済みであること

---

## 1. スプレッドシートの準備

### 1-1. 新しいスプレッドシートの作成

1. [Google スプレッドシート](https://docs.google.com/spreadsheets/)にアクセス
2. 「空白」から新しいスプレッドシートを作成
3. シート名を「体験談データ」に変更

### 1-2. ヘッダー行の設定

1行目に以下のヘッダーを設定してください：

| A | B | C | D | E | F | G | H |
|---|---|---|---|---|---|---|---|
| タイトル | 内容 | 投稿者名 | 投稿日 | 学年 | きっかけ | 状況 | 支援体験 |

### 1-3. サンプルデータの入力（テスト用）

2行目以降にサンプルデータを入力してテストできます：

```
タイトル: 不登校から学校復帰までの道のり
内容: 中学2年生の時に不登校になりましたが、フリースクールに通いながら徐々に学校に戻れるようになりました。
投稿者名: 田中太郎
投稿日: 2025/11/27
学年: 中学生
きっかけ: 不登校
状況: 学校復帰
支援体験: フリースクール
```

### 1-4. スプレッドシートIDの取得

スプレッドシートのURLから、IDを取得します：

```
https://docs.google.com/spreadsheets/d/【ここがスプレッドシートID】/edit
```

例：
```
https://docs.google.com/spreadsheets/d/1ABC-defGHI_jklMNOpqrSTUvwxYZ/edit
                                    ↑
                            このIDをコピーしてください
```

---

## 2. Google Apps Scriptの設定

### 2-1. スクリプトエディタを開く

1. 作成したスプレッドシートを開く
2. メニューから「拡張機能」→「Apps Script」をクリック
3. 新しいタブでApps Scriptエディタが開きます

### 2-2. スクリプトのコピー

1. プロジェクトの `gas/searchExperiences.gs` ファイルを開く
2. 全文をコピー
3. Apps Scriptエディタの `コード.gs` に貼り付け（既存のコードは削除）

### 2-3. スプレッドシートIDの設定

スクリプトの3行目付近にある以下の部分を編集：

```javascript
const SPREADSHEET_ID = 'YOUR_SPREADSHEET_ID_HERE';
```

↓ 取得したスプレッドシートIDに置き換え

```javascript
const SPREADSHEET_ID = '1ABC-defGHI_jklMNOpqrSTUvwxYZ';
```

### 2-4. シート名の確認

スクリプトの6行目付近のシート名が一致しているか確認：

```javascript
const SHEET_NAME = '体験談データ';
```

スプレッドシートのシート名と異なる場合は、ここを修正してください。

### 2-5. 保存

1. ファイル名を「体験談検索API」などに変更（任意）
2. 「プロジェクトを保存」（💾アイコン）をクリック

---

## 3. Web アプリケーションとしてデプロイ

### 3-1. デプロイの実行

1. Apps Scriptエディタの右上にある「デプロイ」→「新しいデプロイ」をクリック
2. 「種類の選択」で「ウェブアプリ」を選択
3. 以下の設定を行う：
   - **説明**: `体験談検索API v1` など（任意）
   - **次のユーザーとして実行**: `自分（あなたのメールアドレス）`
   - **アクセスできるユーザー**: `全員` を選択
4. 「デプロイ」ボタンをクリック

### 3-2. 承認プロセス

初回デプロイ時に承認が必要です：

1. 「アクセスを承認」をクリック
2. 自分のGoogleアカウントを選択
3. 「詳細」をクリック
4. 「（プロジェクト名）に移動」をクリック
5. 「許可」をクリック

### 3-3. デプロイURLの取得

デプロイが完了すると、「ウェブアプリ」のURLが表示されます：

```
https://script.google.com/macros/s/ABC...XYZ/exec
```

このURLをコピーしてください。

**重要**: このURLは `/exec` で終わる必要があります。`/dev` で終わる開発用URLではありません。

---

## 4. React アプリケーションの設定

### 4-1. 環境変数ファイルの作成

プロジェクトのルートディレクトリに `.env` ファイルを作成：

```bash
cp .env.example .env
```

### 4-2. GAS API URLの設定

`.env` ファイルを開いて、取得したデプロイURLを設定：

```env
REACT_APP_GAS_API_URL=https://script.google.com/macros/s/ABC...XYZ/exec
```

### 4-3. 開発サーバーの再起動

環境変数を読み込むため、開発サーバーを再起動：

```bash
# サーバーを停止（Ctrl + C）
npm start
```

---

## 5. 動作確認

### 5-1. 検索ページへアクセス

1. ブラウザで `http://localhost:3000/web_Fukui/experiences` を開く
2. 検索ボックスにキーワードを入力（例：「不登校」）
3. 「検索する」ボタンをクリック

### 5-2. 検索結果の確認

- 検索結果ページに遷移し、該当する体験談が表示されることを確認
- ローディング表示が正しく動作することを確認
- エラーが発生した場合は、ブラウザのコンソールを確認

### 5-3. フィルター機能のテスト

1. 「絞り込み」ボタンをクリック
2. フィルター条件を選択（例：「中学生」「不登校」）
3. 「絞り込む」をクリック
4. フィルター条件に一致する体験談のみが表示されることを確認

---

## 6. トラブルシューティング

### エラー: "TypeError: Failed to fetch"

**原因**:
- `.env` ファイルにGAS APIのURLが設定されていない
- GAS APIのURLが間違っている
- GASがデプロイされていない、または「アクセスできるユーザー」が「全員」になっていない

**解決方法**:
1. `.env` ファイルを確認：
   ```bash
   # .envファイルの内容を確認
   cat .env
   ```
   `REACT_APP_GAS_API_URL` が設定されているか確認

2. 開発サーバーを再起動：
   ```bash
   # Ctrl+C で停止してから
   npm start
   ```
   環境変数の変更は再起動が必要です

3. ブラウザのコンソールで確認：
   ```javascript
   // F12でコンソールを開き、以下を実行
   console.log(process.env.REACT_APP_GAS_API_URL);
   ```
   `undefined` が表示される場合は環境変数が読み込まれていません

4. GASのデプロイURLが正しいか確認：
   - `/exec` で終わっているか（`/dev` ではない）
   - コピー時にスペースなどが入っていないか

### エラー: "検索中にエラーが発生しました"

**原因**:
- GAS APIのURLが正しく設定されていない
- GASスクリプトがデプロイされていない
- スプレッドシートIDが間違っている

**解決方法**:
1. `.env` ファイルの `REACT_APP_GAS_API_URL` を確認
2. GASが正しくデプロイされているか確認
3. Apps Scriptエディタで「実行ログ」を確認

### 検索結果が表示されない

**原因**:
- スプレッドシートにデータがない
- ヘッダー名が一致していない
- キーワードに該当するデータがない

**解決方法**:
1. スプレッドシートにサンプルデータを追加
2. ヘッダー名がスクリプトと一致しているか確認
3. より一般的なキーワードで検索してみる

### CORS エラーが発生する

**原因**:
- GASのデプロイ設定で「アクセスできるユーザー」が正しく設定されていない

**解決方法**:
1. Apps Scriptエディタで「デプロイ」→「デプロイを管理」
2. 「アクセスできるユーザー」が「全員」になっているか確認
3. 必要に応じて新しいバージョンでデプロイし直す

---

## 7. スプレッドシートのデータ構造（詳細）

### 各カラムの説明

| カラム名 | データ型 | 必須 | 説明 |
|---------|---------|------|------|
| タイトル | テキスト | ○ | 体験談のタイトル |
| 内容 | テキスト | ○ | 体験談の本文 |
| 投稿者名 | テキスト | - | 投稿者の名前（未入力の場合は「匿名」） |
| 投稿日 | 日付 | - | 投稿日時 |
| 学年 | テキスト | - | 「小学生」「中学生」「高校生」「卒業生」 |
| きっかけ | テキスト | - | 「不登校」「病気」「いじめ」「発達障がい」「その他」 |
| 状況 | テキスト | - | 「自宅学習」「学校復帰」「進学」「就職」「その他」 |
| 支援体験 | テキスト | - | 「フリースクール」「適応指導教室」「オンライン学習」「家庭教師」「その他」 |

---

## 8. GASスクリプトの更新方法

### 8-1. スクリプトの編集

1. Apps Scriptエディタでコードを編集
2. 「プロジェクトを保存」をクリック

### 8-2. 新しいバージョンのデプロイ

1. 「デプロイ」→「デプロイを管理」をクリック
2. 既存のデプロイの「編集」（鉛筆アイコン）をクリック
3. 「バージョン」で「新バージョン」を選択
4. 「デプロイ」をクリック

**注意**: デプロイURLは変更されないため、Reactアプリの設定変更は不要です。

---

## 9. セキュリティに関する注意事項

### 9-1. スプレッドシートの共有設定

- スプレッドシートには機密情報を含めないでください
- 必要に応じて、スプレッドシートの閲覧権限を制限してください

### 9-2. GASの実行権限

- GASは「自分として実行」に設定されているため、スクリプトはあなたの権限でスプレッドシートにアクセスします
- 投稿機能を有効にする場合、悪意のあるデータが投稿される可能性を考慮してください

### 9-3. レート制限

- GASには1日あたりの実行回数制限があります（無料アカウント: 約20,000回/日）
- 大量のリクエストが予想される場合は、キャッシュの実装を検討してください

---

## 10. 次のステップ

- [ ] 本番環境（GitHub Pages）用の設定
- [ ] 投稿機能の実装
- [ ] データのバックアップ設定
- [ ] 画像アップロード機能の追加
- [ ] 管理画面の作成

---

## サポート

問題が解決しない場合は、以下を確認してください：

1. ブラウザのコンソールエラーログ
2. Apps Scriptの実行ログ（表示 → ログ）
3. `.env` ファイルの設定内容
4. スプレッドシートのデータ構造

---

更新日: 2025年11月27日
