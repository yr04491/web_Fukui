import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import layoutStyles from '../../components/MainContent/commonPageLayout.module.css';
import styles from './AdminPage.module.css';
import Breadcrumbs from '../../components/common/Breadcrumbs';
import Footer from '../../components/common/Footer';
import TweetCard from '../../components/common/TweetCard/TweetCard';
import { getPendingExperiences, getApprovedExperiences, approveExperience, rejectExperience } from '../../utils/gasApi';

const AdminPage = () => {
  const navigate = useNavigate();
  const [activeTab, setActiveTab] = useState('pending'); // 'pending' or 'approved'
  const [pendingExperiences, setPendingExperiences] = useState([]);
  const [approvedExperiences, setApprovedExperiences] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState(null);
  const [pendingPage, setPendingPage] = useState(1);
  const [approvedPage, setApprovedPage] = useState(1);
  const ITEMS_PER_PAGE = 10;

  const breadcrumbItems = [
    { label: 'TOP', path: '/' },
    { label: '管理者画面', path: '/admin' }
  ];

  // データ取得
  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    setIsLoading(true);
    setError(null);
    try {
      const [pending, approved] = await Promise.all([
        getPendingExperiences(),
        getApprovedExperiences()
      ]);
      setPendingExperiences(pending);
      setApprovedExperiences(approved);
    } catch (error) {
      console.error('データ取得エラー:', error);
      setError('データの取得に失敗しました');
    } finally {
      setIsLoading(false);
    }
  };

  // 承認処理
  const handleApprove = async (id) => {
    if (!window.confirm('この体験談を承認しますか？')) return;
    
    try {
      await approveExperience(id);
      alert('承認しました');
      loadData(); // データを再読み込み
    } catch (error) {
      console.error('承認エラー:', error);
      alert('承認に失敗しました');
    }
  };

  // 却下処理
  const handleReject = async (id) => {
    if (!window.confirm('この体験談を却下しますか？')) return;
    
    try {
      await rejectExperience(id);
      alert('却下しました');
      loadData(); // データを再読み込み
    } catch (error) {
      console.error('却下エラー:', error);
      alert('却下に失敗しました');
  // タブ切り替え時にページをリセット
  const handleTabChange = (tab) => {
    setActiveTab(tab);
    if (tab === 'pending') {
      setPendingPage(1);
    } else {
      setApprovedPage(1);
    }
  };

  // 現在のタブのデータとページネーション情報を取得
  const currentExperiences = activeTab === 'pending' ? pendingExperiences : approvedExperiences;
  const currentPage = activeTab === 'pending' ? pendingPage : approvedPage;
  const setCurrentPage = activeTab === 'pending' ? setPendingPage : setApprovedPage;
  
  // ページネーション計算
  const totalPages = Math.ceil(currentExperiences.length / ITEMS_PER_PAGE);
  const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
  const endIndex = startIndex + ITEMS_PER_PAGE;
  const displayedExperiencehandleTabChange('pending')}
          <button>
            未承認体験談 ({pendingExperiences.length})
          </button>
          <button
            className={`${styles.tab} ${activeTab === 'approved' ? styles.activeTab : ''}`}
            onClick={() => handleTabChange
  };

  const currentExperiences = activeTab === 'pending' ? pendingExperiences : approvedExperiences;

  return (
    <div className={layoutStyles.pageContainer}>
      <Breadcrumbs items={breadcrumbItems} />
      
      <div className={layoutStyles.mainContent}>
        <div className={styles.adminHeader}>
          <h1 className={styles.title}>管理者画面</h1>
          <p className={styles.subtitle}>体験談の承認・管理</p>
        </div>

        {/* タブ切り替え */}
        <div className={styles.tabContainer}>
          <bu>
              <div className={styles.experiencesList}>
                {displayedExperiences.map((experience) => (
                  <div key={experience.id} className={styles.experienceItem}>
                    <TweetCard
                      cardId={experience.id}
                      data={experience}
                    />
                    
                    {/* 承認・却下ボタン（未承認時のみ表示） */}
                    {activeTab === 'pending' && (
                      <div className={styles.actionButtons}>
                        <button
                          className={styles.approveButton}
                          onClick={(e) => {
                            e.stopPropagation();
                            handleApprove(experience.id);
                          }}
                        >
                          承認
                        </button>
                        <button
                          className={styles.rejectButton}
                          onClick={(e) => {
                            e.stopPropagation();
                            handleReject(experience.id);
                          }}
                        >
                          却下
                        </button>
                      </div>
                    )}
                  </div>
                ))}
              </div>

              {/* ページネーション */}
              {totalPages > 1 && (
                <div className={styles.pagination}>
                  <button
                    className={styles.pageButton}
                    onClick={() => handlePageChange(currentPage - 1)}
                    disabled={currentPage === 1}
                  >
                    前へ
                  </button>
                  
                  <div className={styles.pageNumbers}>
                    {[...Array(totalPages)].map((_, index) => {
                      const pageNumber = index + 1;
                      return (
                        <button
                          key={pageNumber}
                          className={`${styles.pageNumber} ${currentPage === pageNumber ? styles.activePage : ''}`}
                          onClick={() => handlePageChange(pageNumber)}
                        >
                          {pageNumber}
                        </button>
                      );
                    })}
                  </div>

                  <button
                    className={styles.pageButton}
                    onClick={() => handlePageChange(currentPage + 1)}
                    disabled={currentPage === totalPages}
                  >
                    次へ
                  </button>
                </div>
              )}
            </ {/* 承認・却下ボタン（未承認時のみ表示） */}
                  {activeTab === 'pending' && (
                    <div className={styles.actionButtons}>
                      <button
                        className={styles.approveButton}
                        onClick={(e) => {
                          e.stopPropagation();
                          handleApprove(experience.id);
                        }}
                      >
                        承認
                      </button>
                      <button
                        className={styles.rejectButton}
                        onClick={(e) => {
                          e.stopPropagation();
                          handleReject(experience.id);
                        }}
                      >
                        却下
                      </button>
                    </div>
                  )}
                </div>
              ))}
            </div>
          )}
        </div>
      </div>

      <Footer />
    </div>
  );
};

export default AdminPage;
